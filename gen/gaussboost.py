# Copyright Dan Price. All rights reserved.

import numpy as np
import matplotlib.pyplot as plt

def cheby_poly(n_in, x_in):
    def cheby_poly_recursive(n, x):
        if n <= 1:
            return x if n == 1 else 1.0
        floor_halfn = n >> 1
        floor_halfn_poly = cheby_poly_recursive(floor_halfn, x)
        if (n & 1) == 0: # n is even
            return 2.0*floor_halfn_poly*floor_halfn_poly - 1.0
        return 2.0*floor_halfn_poly*cheby_poly_recursive((n >> 1) + 1, x) - x
    if not isinstance(n_in, int) or n_in < 0:
        raise RuntimeError('cheby_poly(n, x): n must be a nonnegative integer')
    return cheby_poly_recursive(n_in, x_in)

def gauss_boost(x0, a0, x):
    xmx0 = x - x0
    return 1 + a0*np.exp(-xmx0*xmx0/x0)

def cheby_coeff(n):
    return gauss_boost(4, 3, n)/(n*n)

def cheby_waveshape(n_in, x):
    if not isinstance(n_in, int) or n_in < 1:
        raise RuntimeError('cheby_waveshape(n, x): n must be a positive integer')
    return sum([(-1)**((n - 1) >> 1)*cheby_coeff(n)*cheby_poly(n, x) for n in range(1, n_in + 1)])

def gengb(p=10):
    N = 1 << p
    strn = str(N)
    filename = 'GaussBoost.h'

    print('Generating ' + filename + ' with N = ' + strn + '...')

    text =  '// Copyright Dan Price. All rights reserved.\n\n'
    text += '////////////////////////////////////\n'
    text += '//// Generated by gaussboost.py ////\n'
    text += '//// !!!DO NOT EDIT MANUALLY!!! ////\n'
    text += '////////////////////////////////////\n\n'

    text += '#pragma once\n\n'
    text += 'namespace AlbumBot\n'
    text += '{\n'

    print('Generating gauss_boost_cheby_coeff[]...')
    text += '\tconstexpr const double gauss_boost_cheby_coeff[' + strn + '] = {\n'
    text += '\t\t' + str(cheby_coeff(1)) + '\n'
    for n in range(1, N):
        text += '\t\t, ' + str(cheby_coeff(n + 1)) + '\n'
    text += '\t};\n'

    print('Calculating offsets...')
    gboffset = [-cheby_waveshape(n + 1, 0.0) for n in range(N)]

    print('Generating gauss_boost_norm[]...')
    gbnorm = [1.0/(1.0006*(cheby_waveshape(n + 1, 1.0) + gboffset[n])) for n in range(N)]
    text += '\tconstexpr const double gauss_boost_norm[' + strn + '] = {\n'
    text += '\t\t' + str(gbnorm[0]) + '\n'
    for n in range(1, N):
        text += '\t\t, ' + str(gbnorm[n]) + '\n'
    text += '\t};\n'

    print('Generating gauss_boost_offset[]...')
    text += '\tconstexpr const double gauss_boost_offset[' + strn + '] = {\n'
    text += '\t\t0.0\n'
    text += '\t\t' + str(gboffset[0]) + '\n'
    for n in range(1, N):
        text += '\t\t, ' + str(gboffset[n]) + '\n'
    text += '\t};\n'

    print('Generating struct gauss_boost...')
    text += '\ttemplate<size_t n, typename T> struct gauss_boost\n'
    text += '\t{\n'
    text += '\t\tstatic_assert(n > 0 && n <= ' + strn + ', "gauss_boost<n, T>: n must be greater than 0 and less than or equal to ' + strn + '");\n'
    text += '\t\tstatic constexpr const T value = static_cast<T>(gauss_boost_cheby_coeff[n - 1]);\n'
    text += '\t\tstatic constexpr const T norm = static_cast<T>(gauss_boost_norm[n - 1]);\n'
    text += '\t\tstatic constexpr const T offset = static_cast<T>(gauss_boost_offset[n - 1]);\n'
    text += '\t};\n'

    text += '}\n\n'

    print('Writing ' + filename + '...')
    with open(filename, 'w') as f:
        f.write(text)

    print('Done.')

    ntest = 64
    def ws(x):
        return gbnorm[ntest - 1]*(gboffset[ntest - 1] + cheby_waveshape(ntest, x))
    xarr = [2*n/1000 - 1 for n in range(1001)]
    yarr = [ws(x) for x in xarr]
    plt.plot(xarr, yarr)
    plt.show()

